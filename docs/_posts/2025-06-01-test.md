---
title: "Testing"
header:
  teaser: "assets/images/markup-syntax-highlighting-teaser.jpg"
categories:
  - Malware Analysis
tags:
  - Malware Analysis
---

Some specimens combine diverse techniques in a single infection, requiring analysts to be familar with ways where various methods for executing code can work together.

We will start with initial behavioral analysis of a sample `PDFXCview.exe`.

# Sample - PDFXCview.exe
## Infect the System with the Specimen

Start Process hacker and Process Monitor, double-click `PDFXCview.exe` to infect the system.

Note that `PDFXCview.exe` process in Process Hacker and after about 3-5 minutes, it disappears and two `regsvr32.exe` processes appear.
![[Pasted image 20250601021713.png]]

Terminate the `regsvr32.exe` processes in Process Hacker, pause capture and Process Monitor, then examine the *Process Tree*.
![[Pasted image 20250601020912.png]]
Process Tree provides the overview of the processes whose activity Process Monitor has captured during the infection, reconstructing *the listing of the processes that were active*, displaying infomration about them that includes details of their *parent-child relationships*. For every process it shows a *green horizontal bar* that represents *the relative duration of that process*.

## Examine the Process Tree in Process Monitor

Note that `PDFXCview.exe` ran as a child of the Windows Explorer process (`explorer.exe`), since the program has been launched by double-clciking on its icon.

The Process Tree listing also shows that `PDFXCview.exe` launched a child process `regsvr32.exe`, which launched its own `regsvr32.exe` child process, which launched another `regsvr32.exe` child process. Looking at the relative duration of these processes we can tell that the two `regsvr32.exe` instances we observed in Process Hacker were probably the second two child processes, since the first `regsvr32.exe` existed for a very short time.

The location of each `regsvr32.exe` process instance in `C:\WINDOWS\SysWOW64` is not malicious and suggests that these were legitimate `regsvr32.exe` executables that are a part of Microsoft Windows. One possibility for this behavior is that *malware injected malicious code into these processes to evade detection and analysis*.

![[Pasted image 20250601024429.png]]
Also note that one of the `svchost.exe` processes has a child process named `wmiprvse.exe`, which is used to execute Windows Management Instrumentation (WMI) commands, offering legitimate and malicious software a way of interacting with the operating system.

This process has a child named `mshta.exe`, which is designed to execute Microsoft HTML Applications (HTA) files. Attackers could misuse it to *execute JavaScript* outside the browser.

At the bottom of the window the command-line parameters that were passed to it, including JavaScript and appears to be obfuscated.
![[Pasted image 20250601024623.png]]

`mshta.exe` has a child process `powershell.exe` as well.
![[Pasted image 20250601024657.png]]

## Examine the Infection in ProcDOT

Save the activity log in Process Monitor as CSV.
![[Pasted image 20250601025950.png]]

Import into ProcDOT.
![[Pasted image 20250601030007.png]]

Select the `PDFXCview.exe` process in Launcher area and click Refresh to generate the graph that represents the key events captured by Process Monitor during the infection.
![[Pasted image 20250601030032.png]]

The graph shows that when `PDFXCview.exe` ran, it launched an `regsvr32.exe` child process and created a few registry keys.
![[Pasted image 20250601025648.png]]

The specimen created an entry under the `â€¦\Run` registry key.
![[Pasted image 20250601030304.png]]

The entry is set up to run the batch file `c:\users\rem\AppData\Local\8297\bdf6.bat`, which the malware also generated during the infection

We can also see that the specimen created a file with the unusual extension `.2ed62` in the same folder (`C:\Users\REM\AppData\Local\8297`).
![[Pasted image 20250601030335.png]]
The specimen also created several registry entries under `HKCU\Software\Classes` that correspond to the unusual file extension `.2ed62`. These registry keys specify which program Windows should execute when the user attempts to open a file that has the corresponding extension.

## Examine the Files Created by the Specimen

Navigate to the directory that the specimen created in `C:\Users\REM\AppData\Local` to examine its files. The auto-run registry key executes the `.bat` batch file. The batch file executes the file with the strange extension.
![[Pasted image 20250601030548.png]]

### bdf6.bat

View the batch file `bdf6.bat` contents with Notepad++.
```bash
start "4ZMGVELP804VjADRzS" "%LOCALAPPDATA%\8297\d031.2ed62"
```
The first parameter to `start` is the desired title of the window, which is irrelevant here.

### d031.2ed62

The file's contents are unintelligible. There is a possibility that they *might be encrypted or
encoded*.
![[Pasted image 20250601030918.png]]

## Examine Registry Keys Created by the Specimen

We noted that the specimen created registry keys under `HKCU\Software\Classes`. This part of the registry directs the operating system which programs it should use for opening which file extensions. `.2ed62`.
![[Pasted image 20250601031027.png]]
The registry key has a value named "`(Default)`", which contains a data field composed of random-looking hexadecimal characters. Here, the field is set t o0346, but the data on your system might be different.

The string 0346 stored in this field indicates that we need to look at the registry key `HKEY_CURRENT_USER\Software\Classes\0346`, which was also created by the specimen, to see how Windows is supposed to handle files with the `.2ed62` extension.

Because the example is for the value 0346, we went to
`HKEY_CURRENT_USER\Software\Classes\0346\shell\open\command`.
![[Pasted image 20250601031223.png]]
Double-click "(Default)" to bring up the Edit String dialog box. Select all contents in the "Value data:" area; then right-click them and click Copy to copy them to the clipboard. Next, click Cancel to close the dialog box, then minimize Regedit.

### JavaScript code with mshta.exe

Examine the JavaScript code storeed in `HKEY_CURRENT_USER\Software\Classes\0346\shell\open\command`.
```javascript
"C:\WINDOWS\system32\mshta.exe" "javascript:uhgC8XMI4="83R74";V7U6=new
ActiveXObject("WScript.Shell");o1fuO0X="r9lz31a";C3gsB9=V7U6.RegRead("HKCU\\so
ftware\\gxyhwinsg\\zbrqoytjz");Xi5Rym="Jxfk0Q2j";eval(C3gsB9);VANv8cr="8";"
```
By looking on the JavaScript that is being executed using `mshta.exe`, we can see that the script is attempting to read registry contents under `HKCU\software\gxyhwinsg\zbrqoytjz` into the variable named `IV2u4L`. It then executes these contents using eval. The names of the registry entries and variables will probably be different on your system because the specimen appears to generate them differently for every infection.

Make a note of the registry key path and value that the specimen on your system used for storing the JavaScript, which it attempts to execute via *eval*. For instance, the registry key path is `HKCU\software\gxyhwinsg` and the value is "`zbrqoytjz`"

You will find obfuscated JavaScript in that registry path using Regedit.
![[Pasted image 20250601031356.png]]

Save the obfuscated JavaScript from the registry into its own file using *reg_export*.
```powershell
reg_export HKCU\Software\gxyhwinsg zbrqoytjz script.js
```

An alternative to using *reg_export* is to launch PowerShell and to issue this command, which you should type in a single line even though it's wrapped across two lines below:
```powershell
$(Get-ItemProperty -Path HKCU:\Software\gxyhwinsg -Name zbrqoytjz).zbrqoytjz
> script.js
```

Analyze and deobfuscate the obfuscated JavaScript on REMnux.


